# Loop API Specification

Complete API documentation for the Loop quiz application backend.

---

## Base Information

**Backend Framework**: Hono  
**Runtime**: Cloudflare Workers (Edge)  
**Validation**: Zod schemas  
**Base URL**: 
- Development: `http://localhost:8787` //to be affixed
- Production: `https://loop-api.workers.dev`//to be generated by vercel

---

## Endpoints

### GET /api/quiz

Retrieves the quiz questions.

#### Request
```http
GET /api/quiz HTTP/1.1
Host: loop-api.workers.dev
Accept: application/json
```

**Headers**:
- `Accept: application/json` (optional)

**Query Parameters**: None

**Authentication**: None required

#### Response

**Success (200 OK)**
```json
{
  "questions": [
    {
      "id": "q1",
      "type": "radio",
      "question": "Which HTTP status code indicates successful resource creation?",
      "choices": [
        "200 OK",
        "201 Created",
        "204 No Content",
        "202 Accepted"
      ],
      "correctIndex": 1
    },
    {
      "id": "q2",
      "type": "checkbox",
      "question": "Which of the following are JavaScript frameworks? (Select all that apply)",
      "choices": [
        "React",
        "Python",
        "Vue",
        "Angular",
        "Java"
      ],
      "correctIndexes": [0, 2, 3]
    },
    {
      "id": "q3",
      "type": "text",
      "question": "What does CSS stand for?",
      "correctText": "Cascading Style Sheets"
    }
  ]
}
```

**Error (500 Internal Server Error)**
```json
{
  "error": "Failed to load questions"
}
```

#### Response Schema
```typescript
interface QuizResponse {
  questions: Question[];
}

type Question = RadioQuestion | CheckboxQuestion | TextQuestion;

interface BaseQuestion {
  id: string;
  type: 'radio' | 'checkbox' | 'text';
  question: string;
}

interface RadioQuestion extends BaseQuestion {
  type: 'radio';
  choices: string[];
  correctIndex: number;
}

interface CheckboxQuestion extends BaseQuestion {
  type: 'checkbox';
  choices: string[];
  correctIndexes: number[];
}

interface TextQuestion extends BaseQuestion {
  type: 'text';
  correctText: string;
}
```

#### Validation Rules

- Must return exactly 12 questions
- Question distribution: 4 radio, 4 checkbox, 4 text
- Each question must have unique `id`
- Radio questions must have `correctIndex` between 0 and `choices.length - 1`
- Checkbox questions must have at least one correct index
- Text questions must have non-empty `correctText`

#### Example cURL
```bash
curl -X GET https://loop-api.workers.dev/api/quiz \
  -H "Accept: application/json"
```

---

### POST /api/grade

Grades the user's quiz answers.

#### Request
```http
POST /api/grade HTTP/1.1
Host: loop-api.workers.dev
Content-Type: application/json
Accept: application/json

{
  "answers": [
    { "id": "q1", "value": 1 },
    { "id": "q2", "value": [0, 2, 3] },
    { "id": "q3", "value": "Cascading Style Sheets" }
  ]
}
```

**Headers**:
- `Content-Type: application/json` (required)
- `Accept: application/json` (optional)

**Authentication**: None required

#### Request Body Schema
```typescript
interface GradeRequest {
  answers: Answer[];
}

interface Answer {
  id: string;
  value: string | number | number[];
}
```

**Zod Validation Schema**:
```typescript
import { z } from 'zod';

const AnswerSchema = z.object({
  id: z.string().min(1),
  value: z.union([
    z.string(),
    z.number(),
    z.array(z.number())
  ]),
});

const GradeRequestSchema = z.object({
  answers: z.array(AnswerSchema).min(1).max(12),
});
```

#### Request Validation Rules

- `answers` array must contain 1-12 items
- Each answer must have a valid `id` (string)
- Answer `value` types:
  - Radio: `number` (index of selected choice)
  - Checkbox: `number[]` (array of selected indices)
  - Text: `string` (text answer)

#### Response

**Success (200 OK)**
```json
{
  "score": 10,
  "total": 12,
  "results": [
    { "id": "q1", "correct": true },
    { "id": "q2", "correct": false },
    { "id": "q3", "correct": true },
    { "id": "q4", "correct": true },
    { "id": "q5", "correct": false },
    { "id": "q6", "correct": true },
    { "id": "q7", "correct": true },
    { "id": "q8", "correct": true },
    { "id": "q9", "correct": true },
    { "id": "q10", "correct": true },
    { "id": "q11", "correct": true },
    { "id": "q12", "correct": true }
  ]
}
```

**Validation Error (400 Bad Request)**
```json
{
  "error": "Invalid request body",
  "details": [
    {
      "field": "answers[0].value",
      "message": "Expected number, received string"
    }
  ]
}
```

**Server Error (500 Internal Server Error)**
```json
{
  "error": "Failed to grade quiz"
}
```

#### Response Schema
```typescript
interface GradeResponse {
  score: number;
  total: number;
  results: QuestionResult[];
}

interface QuestionResult {
  id: string;
  correct: boolean;
}
```

#### Grading Logic

**Radio Questions**:
```typescript
function gradeRadio(answer: number, correctIndex: number): boolean {
  return answer === correctIndex;
}
```

**Checkbox Questions**:
```typescript
function gradeCheckbox(answer: number[], correctIndexes: number[]): boolean {
  if (answer.length !== correctIndexes.length) return false;
  
  const sorted1 = [...answer].sort((a, b) => a - b);
  const sorted2 = [...correctIndexes].sort((a, b) => a - b);
  
  return sorted1.every((val, idx) => val === sorted2[idx]);
}
```

**Text Questions**:
```typescript
function gradeText(answer: string, correctText: string): boolean {
  return answer.trim().toLowerCase() === correctText.trim().toLowerCase();
}
```

#### Example cURL
```bash
curl -X POST https://loop-api.workers.dev/api/grade \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{
    "answers": [
      { "id": "q1", "value": 1 },
      { "id": "q2", "value": [0, 2] }
    ]
  }'
```

---

## CORS Configuration

The API must allow cross-origin requests from the frontend.
```typescript
import { cors } from 'hono/cors';

app.use('/*', cors({
  origin: [
    'http://localhost:3000',
    'https://loop-quiz.vercel.app',
    'https://*.vercel.app' // For preview deployments
  ],
  allowMethods: ['GET', 'POST', 'OPTIONS'],
  allowHeaders: ['Content-Type', 'Accept'],
  maxAge: 86400, // 24 hours
}));
```

---

## Error Handling

### Error Response Format

All errors follow this structure:
```typescript
interface ErrorResponse {
  error: string;
  details?: Array<{
    field: string;
    message: string;
  }>;
}
```

### HTTP Status Codes

| Code | Meaning | When Used |
|------|---------|-----------|
| 200 | OK | Successful request |
| 400 | Bad Request | Invalid request body, validation failed |
| 404 | Not Found | Invalid endpoint |
| 405 | Method Not Allowed | Wrong HTTP method |
| 500 | Internal Server Error | Server error, unexpected failure |

### Error Handling Example
```typescript
app.post('/api/grade', async (c) => {
  try {
    const body = await c.req.json();
    
    // Validate with Zod
    const validated = GradeRequestSchema.parse(body);
    
    // Grade answers
    const result = gradeAnswers(validated.answers);
    
    return c.json(result);
    
  } catch (error) {
    if (error instanceof z.ZodError) {
      return c.json({
        error: 'Invalid request body',
        details: error.errors.map(e => ({
          field: e.path.join('.'),
          message: e.message,
        })),
      }, 400);
    }
    
    console.error('Grading error:', error);
    return c.json({
      error: 'Failed to grade quiz',
    }, 500);
  }
});
```

---

## Mock Data Structure

### Questions Database

Store in `backend/src/data/questions.ts`:
```typescript
export const mockQuestions: Question[] = [
  // Radio questions (4)
  {
    id: 'q1',
    type: 'radio',
    question: 'Which HTTP status code indicates successful resource creation?',
    choices: ['200 OK', '201 Created', '204 No Content', '202 Accepted'],
    correctIndex: 1,
  },
  {
    id: 'q2',
    type: 'radio',
    question: 'What does the "await" keyword do in JavaScript?',
    choices: [
      'Delays code execution',
      'Pauses until a Promise resolves',
      'Creates a new Promise',
      'Cancels a Promise'
    ],
    correctIndex: 1,
  },
  {
    id: 'q3',
    type: 'radio',
    question: 'Which CSS property controls text size?',
    choices: ['text-size', 'font-size', 'text-style', 'font-weight'],
    correctIndex: 1,
  },
  {
    id: 'q4',
    type: 'radio',
    question: 'What is the correct syntax for a for loop in JavaScript?',
    choices: [
      'for (i = 0; i < 5)',
      'for i = 0 to 5',
      'for (let i = 0; i < 5; i++)',
      'foreach (i in 5)'
    ],
    correctIndex: 2,
  },
  
  // Checkbox questions (4)
  {
    id: 'q5',
    type: 'checkbox',
    question: 'Which of these are JavaScript frameworks? (Select all that apply)',
    choices: ['React', 'Python', 'Vue', 'Angular', 'Java'],
    correctIndexes: [0, 2, 3],
  },
  {
    id: 'q6',
    type: 'checkbox',
    question: 'Which HTTP methods are safe (read-only)? (Select all that apply)',
    choices: ['GET', 'POST', 'PUT', 'DELETE', 'HEAD'],
    correctIndexes: [0, 4],
  },
  {
    id: 'q7',
    type: 'checkbox',
    question: 'Which are valid CSS units? (Select all that apply)',
    choices: ['px', 'rem', 'pt', 'dp', 'em'],
    correctIndexes: [0, 1, 2, 4],
  },
  {
    id: 'q8',
    type: 'checkbox',
    question: 'Which can be used for state management in React? (Select all that apply)',
    choices: ['useState', 'useReducer', 'Redux', 'Angular', 'Context API'],
    correctIndexes: [0, 1, 2, 4],
  },
  
  // Text questions (4)
  {
    id: 'q9',
    type: 'text',
    question: 'What does CSS stand for?',
    correctText: 'Cascading Style Sheets',
  },
  {
    id: 'q10',
    type: 'text',
    question: 'What does HTML stand for?',
    correctText: 'HyperText Markup Language',
  },
  {
    id: 'q11',
    type: 'text',
    question: 'What is the default port for HTTP?',
    correctText: '80',
  },
  {
    id: 'q12',
    type: 'text',
    question: 'What keyword is used to declare a constant in JavaScript?',
    correctText: 'const',
  },
];
```

---

## Implementation Guidelines

### Project Structure
```
backend/
├── src/
│   ├── index.ts              # Main Hono app
│   ├── routes/
│   │   ├── quiz.ts          # GET /api/quiz handler
│   │   └── grade.ts         # POST /api/grade handler
│   ├── data/
│   │   └── questions.ts     # Mock questions
│   ├── schemas/
│   │   └── validation.ts    # Zod schemas
│   └── utils/
│       └── grading.ts       # Grading logic functions
├── package.json
├── wrangler.toml
└── tsconfig.json
```

### Main App Setup
```typescript
// src/index.ts
import { Hono } from 'hono';
import { cors } from 'hono/cors';
import quizRoute from './routes/quiz';
import gradeRoute from './routes/grade';

const app = new Hono();

// CORS middleware
app.use('/*', cors({
  origin: ['http://localhost:3000', 'https://*.vercel.app'],
  allowMethods: ['GET', 'POST', 'OPTIONS'],
  allowHeaders: ['Content-Type', 'Accept'],
}));

// Routes
app.route('/api', quizRoute);
app.route('/api', gradeRoute);

// Health check
app.get('/', (c) => c.json({ status: 'ok', message: 'Loop API' }));

// 404 handler
app.notFound((c) => c.json({ error: 'Not found' }, 404));

// Error handler
app.onError((err, c) => {
  console.error('Server error:', err);
  return c.json({ error: 'Internal server error' }, 500);
});

export default app;
```

### Quiz Route
```typescript
// src/routes/quiz.ts
import { Hono } from 'hono';
import { mockQuestions } from '../data/questions';

const quiz = new Hono();

quiz.get('/quiz', (c) => {
  try {
    return c.json({ questions: mockQuestions });
  } catch (error) {
    console.error('Failed to load questions:', error);
    return c.json({ error: 'Failed to load questions' }, 500);
  }
});

export default quiz;
```

### Grade Route
```typescript
// src/routes/grade.ts
import { Hono } from 'hono';
import { z } from 'zod';
import { GradeRequestSchema } from '../schemas/validation';
import { gradeAnswers } from '../utils/grading';

const grade = new Hono();

grade.post('/grade', async (c) => {
  try {
    const body = await c.req.json();
    
    // Validate request
    const validated = GradeRequestSchema.parse(body);
    
    // Grade answers
    const result = gradeAnswers(validated.answers);
    
    return c.json(result);
    
  } catch (error) {
    if (error instanceof z.ZodError) {
      return c.json({
        error: 'Invalid request body',
        details: error.errors.map(e => ({
          field: e.path.join('.'),
          message: e.message,
        })),
      }, 400);
    }
    
    console.error('Grading error:', error);
    return c.json({ error: 'Failed to grade quiz' }, 500);
  }
});

export default grade;
```

### Validation Schemas
```typescript
// src/schemas/validation.ts
import { z } from 'zod';

export const AnswerSchema = z.object({
  id: z.string().min(1),
  value: z.union([
    z.string(),
    z.number(),
    z.array(z.number())
  ]),
});

export const GradeRequestSchema = z.object({
  answers: z.array(AnswerSchema).min(1).max(12),
});

export type GradeRequest = z.infer<typeof GradeRequestSchema>;
export type Answer = z.infer<typeof AnswerSchema>;
```

### Grading Utility
```typescript
// src/utils/grading.ts
import { mockQuestions } from '../data/questions';
import type { Answer } from '../schemas/validation';

interface GradeResult {
  score: number;
  total: number;
  results: Array<{ id: string; correct: boolean }>;
}

export function gradeAnswers(answers: Answer[]): GradeResult {
  const results = mockQuestions.map(question => {
    const answer = answers.find(a => a.id === question.id);
    
    if (!answer) {
      return { id: question.id, correct: false };
    }
    
    const correct = gradeQuestion(question, answer.value);
    return { id: question.id, correct };
  });
  
  const score = results.filter(r => r.correct).length;
  
  return {
    score,
    total: mockQuestions.length,
    results,
  };
}

function gradeQuestion(question: any, value: any): boolean {
  switch (question.type) {
    case 'radio':
      return value === question.correctIndex;
    
    case 'checkbox':
      if (!Array.isArray(value)) return false;
      const sorted1 = [...value].sort((a, b) => a - b);
      const sorted2 = [...question.correctIndexes].sort((a, b) => a - b);
      return JSON.stringify(sorted1) === JSON.stringify(sorted2);
    
    case 'text':
      return String(value).trim().toLowerCase() === 
             question.correctText.trim().toLowerCase();
    
    default:
      return false;
  }
}
```

---

## Testing

### Manual Testing with cURL

**Test GET /api/quiz**:
```bash
curl -X GET http://localhost:8787/api/quiz
```

**Test POST /api/grade**:
```bash
curl -X POST http://localhost:8787/api/grade \
  -H "Content-Type: application/json" \
  -d '{
    "answers": [
      {"id": "q1", "value": 1},
      {"id": "q2", "value": 1},
      {"id": "q3", "value": 1},
      {"id": "q4", "value": 2},
      {"id": "q5", "value": [0, 2, 3]},
      {"id": "q6", "value": [0, 4]},
      {"id": "q7", "value": [0, 1, 2, 4]},
      {"id": "q8", "value": [0, 1, 2, 4]},
      {"id": "q9", "value": "Cascading Style Sheets"},
      {"id": "q10", "value": "HyperText Markup Language"},
      {"id": "q11", "value": "80"},
      {"id": "q12", "value": "const"}
    ]
  }'
```

### Expected Results

Perfect score (12/12):
```json
{
  "score": 12,
  "total": 12,
  "results": [
    {"id": "q1", "correct": true},
    {"id": "q2", "correct": true},
    // ... all true
  ]
}
```

---

## Deployment

### Wrangler Configuration
```toml
# wrangler.toml
name = "loop-api"
main = "src/index.ts"
compatibility_date = "2024-01-01"

[env.production]
name = "loop-api"
route = "loop-api.workers.dev/*"
```

### Deploy Commands
```bash
# Development
npm run dev

# Deploy to production
npm run deploy
```

---

End of API Specification